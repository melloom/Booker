<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://*.google-analytics.com; script-src-elem 'self' 'unsafe-inline' https://www.gstatic.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://*.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data: https: https://*.google-analytics.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.google-analytics.com; frame-src 'self' https://*.google-analytics.com;">
    <title>Appointment Scheduler - WFM</title>
    <!-- Add Firebase SDK -->
    <script type="module" src="./firebase-config.js"></script>
    <!-- Add Firebase Collections -->
    <script type="module" src="./firebase-collections.js"></script>
    <!-- Add User Info Handler -->
    <script type="module" src="./schedule-user-info.js"></script>
    <!-- Add Booking Modal -->
    <script type="module">
        import { openBookingModal } from './booking-modal.js';
        window.openBookingModal = openBookingModal;
    </script>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-color: #1e293b;
            --text-light: #64748b;
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        .header {
            background-color: var(--card-background);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.9);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .user-role {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-weight: 500;
        }

        .user-role.admin {
            background-color: #2563eb;
            color: white;
        }

        .user-role.manager {
            background-color: #f59e0b;
            color: white;
        }

        .user-role.user {
            background-color: #64748b;
            color: white;
        }

        .main-container {
            max-width: 1600px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .day-navigation {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #e2e8f0;
        }

        .day-navigation::-webkit-scrollbar {
            height: 4px;
        }

        .day-navigation::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 2px;
        }

        .day-navigation::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
        }

        .day-button {
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            background-color: white;
            border: 2px solid #e2e8f0;
            color: var(--text-color);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .day-button:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .day-button.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .day-button.today {
            border-color: var(--success-color);
        }

        .day-button i {
            font-size: 0.875rem;
        }

        .regions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        .region-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
            margin-bottom: 1rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .region-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .region-header {
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            flex-shrink: 0;
        }

        .region-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .region-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .products-container {
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            flex: 1;
            min-width: 0; /* Prevent grid items from overflowing */
        }

        .product-section {
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
            min-width: 0; /* Prevent content from overflowing */
        }

        .product-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .product-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .product-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .time-slots-grid {
            display: grid;
            gap: 0.5rem;
            overflow-y: auto;
            max-height: 400px;
            padding-right: 0.5rem;
            min-width: 0; /* Prevent content from overflowing */
        }

        .time-slot {
            background-color: white;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            cursor: pointer;
            min-width: 0; /* Prevent content from overflowing */
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .time-slot:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .time {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            min-width: 0;
            flex: 1;
        }

        .time i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .availability {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 0;
            flex-shrink: 0;
        }

        .slot-count {
            background-color: #f1f5f9;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .slot-count i {
            font-size: 1.1rem;
        }

        .slot-count.low {
            background-color: #fef2f2;
            color: #991b1b;
        }

        .slot-count.low i {
            color: var(--danger-color);
        }

        .logout-button {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-button:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }

        .admin-controls {
            display: none;
            margin-top: 2rem;
            padding: 1rem;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .admin-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }

        @media (max-width: 1400px) {
            .regions-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }

            .products-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .regions-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0.75rem;
            }

            .regions-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .region-card {
                min-height: auto;
                margin-bottom: 0.75rem;
            }

            .products-container {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .product-section {
                padding: 0.75rem;
            }

            .time-slots-grid {
                max-height: 300px;
            }

            .time-slot {
                padding: 0.5rem;
            }

            .time {
                font-size: 0.8rem;
            }

            .slot-count {
                padding: 0.2rem 0.5rem;
                font-size: 0.7rem;
            }
        }

        /* Add smooth scrolling to time slots */
        .time-slots-grid::-webkit-scrollbar {
            width: 6px;
        }

        .time-slots-grid::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .time-slots-grid::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .time-slots-grid::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover);
        }

        /* Ensure text doesn't overflow in time slots */
        .time-slot * {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Add container query support for better responsiveness */
        @container (min-width: 400px) {
            .products-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @container (max-width: 399px) {
            .products-container {
                grid-template-columns: 1fr;
            }
        }

        .size-controls {
            display: none;
        }

        .size-slider {
            display: none;
        }

        .size-value {
            display: none;
        }

        /* Booking Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .booking-modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.25rem;
            width: 90%;
            max-width: 350px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal-overlay.active .booking-modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: var(--danger-color);
        }

        .booking-info {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .info-group {
            display: grid;
            gap: 0.5rem;
        }

        .info-group-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
        }

        .info-item i {
            color: var(--primary-color);
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .info-item-content {
            flex: 1;
        }

        .info-item-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.125rem;
        }

        .info-item-value {
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.875rem;
        }

        .booking-summary {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e2e8f0;
        }

        .summary-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.75rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .modal-button {
            padding: 0.625rem 1.25rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .confirm-button {
            background-color: var(--primary-color);
            color: white;
        }

        .confirm-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }

        .cancel-button {
            background-color: #f1f5f9;
            color: var(--text-color);
        }

        .cancel-button:hover {
            background-color: #e2e8f0;
            transform: translateY(-2px);
        }

        /* User Bookings Styles */
        .user-bookings-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-top: 2rem;
        }

        .user-bookings-grid {
            display: grid;
            gap: 1.5rem;
        }

        .user-booking-card {
            background: var(--background-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: grid;
            gap: 1rem;
            transition: transform 0.2s ease;
        }

        .user-booking-card:hover {
            transform: translateY(-2px);
        }

        .user-booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .user-booking-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-booking-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .user-booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .user-booking-detail {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
        }

        .user-booking-detail i {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .user-booking-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e2e8f0;
        }

        .user-booking-action-button {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cancel-user-booking {
            background: #fee2e2;
            color: #991b1b;
        }

        .cancel-user-booking:hover {
            background: #fecaca;
            transform: translateY(-2px);
        }

        /* Cancellation Modal */
        .cancellation-form {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #f8fafc;
            border-radius: var(--border-radius);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            resize: vertical;
            font-family: inherit;
            font-size: 0.875rem;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .time-slots-container {
            margin-top: 2rem;
        }

        .time-slot-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .time-slot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .time-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .time-slot-header h5 {
            margin: 0;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .duration {
            font-size: 0.875rem;
            color: #64748b;
        }

        .time-slot-body {
            margin-bottom: 1rem;
        }

        .time-slot-body p {
            margin: 0.25rem 0;
            color: #475569;
        }

        .book-button {
            width: 100%;
            padding: 0.5rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .book-button:hover {
            background-color: #2563eb;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .day-section {
            margin-bottom: 2rem;
        }

        .day-header {
            background: #f8fafc;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .day-title {
            margin: 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .time-slots-grid {
                grid-template-columns: 1fr;
            }
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
            margin-left: auto;
        }

        .admin-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }

        .layout-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            flex: 1;
            justify-content: center;
            min-width: 0;
        }

        @media (max-width: 1200px) {
            .header-content {
                justify-content: center;
            }

            .user-info {
                order: 1;
                width: 100%;
                justify-content: center;
                margin-bottom: 0.5rem;
            }

            .layout-controls {
                order: 2;
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .header-actions {
                order: 3;
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0.5rem;
            }

            .layout-controls {
                padding: 0.5rem;
            }

            .layout-options,
            .filter-options {
                width: 100%;
                justify-content: center;
            }

            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }

            .admin-button,
            .logout-button {
                width: 100%;
                justify-content: center;
            }
        }

        /* Add new filter styles */
        .filter-bar {
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--background-color);
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.875rem;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        .filter-checkbox input[type="checkbox"]:checked {
            background-color: var(--primary-color);
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            background: white;
            color: var(--text-color);
            font-size: 0.875rem;
            cursor: pointer;
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .filter-icon {
            color: var(--primary-color);
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background-color: #f1f5f9;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .booking-details {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .booking-details p {
            margin: 0.5rem 0;
            color: var(--text-color);
        }

        .booking-details strong {
            color: var(--text-light);
        }

        .submit-button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .submit-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-details">
                    <div class="user-name" id="userName"></div>
                    <div class="user-role" id="userRole"></div>
                </div>
            </div>
            <div class="layout-controls">
                <button id="adminDashboardButton" class="admin-button" style="display: none;" onclick="window.location.href='admin-dashboard.html'">
                    <i class="fas fa-cog"></i> Admin Dashboard
                </button>
                <button class="logout-button" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <h1 class="page-title">
            <i class="fas fa-calendar-alt"></i>
            Appointment Scheduling
        </h1>
        <div class="day-navigation" id="dayNavigation">
            <button class="day-button" data-day="same-day">
                <i class="fas fa-calendar-day"></i>
                Same Day
            </button>
            <!-- Days will be populated by JavaScript -->
        </div>
        <div class="filter-bar">
            <div class="filter-group">
                <i class="fas fa-filter filter-icon"></i>
                <label>Service Type:</label>
                <div class="filter-checkbox">
                    <input type="checkbox" id="filterBathrooms" checked>
                    <label for="filterBathrooms">Bathrooms</label>
                </div>
                <div class="filter-checkbox">
                    <input type="checkbox" id="filterRoofing" checked>
                    <label for="filterRoofing">Roofing</label>
                </div>
            </div>
            <div class="filter-group">
                <i class="fas fa-map-marker-alt filter-icon"></i>
                <label>Region:</label>
                <select class="filter-select" id="regionFilter">
                    <option value="all">All Regions</option>
                    <!-- Regions will be populated dynamically -->
                </select>
            </div>
        </div>
        <div class="regions-grid">
            <!-- MIDA (DC, Virginia, Maryland) -->
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">MIDA</div>
                    <div class="region-subtitle">DC, Virginia, Maryland</div>
                </div>
                <div class="products-container">
                    <!-- Bathrooms Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-bath"></i>
                            </div>
                            <div class="product-title">Bathrooms</div>
                        </div>
                        <div class="time-slots-grid" id="mida-bathrooms-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>

                    <!-- Roofing Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="product-title">Roofing</div>
                        </div>
                        <div class="time-slots-grid" id="mida-roofing-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- SOPA (Southern Pennsylvania) -->
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">SOPA</div>
                    <div class="region-subtitle">Southern Pennsylvania</div>
                </div>
                <div class="products-container">
                    <!-- Bathrooms Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-bath"></i>
                            </div>
                            <div class="product-title">Bathrooms</div>
                        </div>
                        <div class="time-slots-grid" id="sopa-bathrooms-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>

                    <!-- Roofing Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="product-title">Roofing</div>
                        </div>
                        <div class="time-slots-grid" id="sopa-roofing-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- SOVAS (Southern Virginia) -->
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">SOVAS</div>
                    <div class="region-subtitle">Southern Virginia</div>
                </div>
                <div class="products-container">
                    <!-- Bathrooms Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-bath"></i>
                            </div>
                            <div class="product-title">Bathrooms</div>
                        </div>
                        <div class="time-slots-grid" id="sovas-bathrooms-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>

                    <!-- Roofing Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="product-title">Roofing</div>
                        </div>
                        <div class="time-slots-grid" id="sovas-roofing-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Florida -->
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">Florida</div>
                </div>
                <div class="products-container">
                    <!-- Bathrooms Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-bath"></i>
                            </div>
                            <div class="product-title">Bathrooms</div>
                        </div>
                        <div class="time-slots-grid" id="florida-bathrooms-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>

                    <!-- Roofing Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="product-title">Roofing</div>
                        </div>
                        <div class="time-slots-grid" id="florida-roofing-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- New England (Massachusetts and Rhode Island) -->
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">New England</div>
                    <div class="region-subtitle">Massachusetts & Rhode Island</div>
                </div>
                <div class="products-container">
                    <!-- Bathrooms Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-bath"></i>
                            </div>
                            <div class="product-title">Bathrooms</div>
                        </div>
                        <div class="time-slots-grid" id="new-england-bathrooms-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>

                    <!-- Roofing Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="product-title">Roofing</div>
                        </div>
                        <div class="time-slots-grid" id="new-england-roofing-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connecticut -->
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">Connecticut</div>
                </div>
                <div class="products-container">
                    <!-- Bathrooms Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-bath"></i>
                            </div>
                            <div class="product-title">Bathrooms</div>
                        </div>
                        <div class="time-slots-grid" id="connecticut-bathrooms-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>

                    <!-- Roofing Section -->
                    <div class="product-section">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="product-title">Roofing</div>
                        </div>
                        <div class="time-slots-grid" id="connecticut-roofing-slots">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="adminControls" class="admin-controls">
            <button class="admin-button" onclick="window.location.href='admin-dashboard.html'">
                <i class="fas fa-cog"></i> Admin Dashboard
            </button>
        </div>
    </div>

    <div id="timeSlotsContainer" class="time-slots-container">
        <!-- Time slots will be populated here -->
    </div>

    <!-- Booking Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="booking-modal">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Booking</h2>
                <button class="close-modal" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="booking-details">
                <div class="booking-info">
                    <div class="info-group">
                        <div class="info-group-title">Appointment Details</div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div class="info-item-content">
                                <div class="info-item-label">Region</div>
                                <div class="info-item-value" id="modalRegion"></div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-bath"></i>
                            <div class="info-item-content">
                                <div class="info-item-label">Service Type</div>
                                <div class="info-item-value" id="modalProduct"></div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="far fa-clock"></i>
                            <div class="info-item-content">
                                <div class="info-item-label">Appointment Time</div>
                                <div class="info-item-value" id="modalTime"></div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calendar"></i>
                            <div class="info-item-content">
                                <div class="info-item-label">Date</div>
                                <div class="info-item-value" id="modalDate"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="booking-summary">
                    <div class="summary-title">Booking Summary</div>
                    <div class="summary-item">
                        <span class="summary-label">Estimated Duration</span>
                        <span class="summary-value">60-90 minutes</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Available Parties</span>
                        <span class="summary-value">All parties available</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Service Provider</span>
                        <span class="summary-value">Professional Team</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Preparation Required</span>
                        <span class="summary-value">Clear access area</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-button cancel-button" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="modal-button confirm-button" onclick="confirmBooking()">
                    <i class="fas fa-check"></i>
                    Confirm Booking
                </button>
            </div>
        </div>
    </div>

    <!-- Cancellation Modal -->
    <div class="modal-overlay" id="cancellationModal">
        <div class="booking-modal">
            <div class="modal-header">
                <h2 class="modal-title">Cancel Appointment</h2>
                <button class="close-modal" onclick="closeCancellationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="booking-details">
                <div class="booking-info">
                    <div class="info-group">
                        <div class="info-group-title">Appointment Details</div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div class="info-item-content">
                                <div class="info-item-label">Region</div>
                                <div class="info-item-value" id="cancelRegion"></div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-bath"></i>
                            <div class="info-item-content">
                                <div class="info-item-label">Service Type</div>
                                <div class="info-item-value" id="cancelProduct"></div>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="far fa-clock"></i>
                            <div class="info-item-content">
                                <div class="info-item-label">Appointment Time</div>
                                <div class="info-item-value" id="cancelTime"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="cancellation-form">
                    <div class="form-group">
                        <label for="cancellationReason">Reason for Cancellation</label>
                        <textarea id="cancellationReason" rows="4" placeholder="Please provide a reason for cancelling this appointment..." required></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-button cancel-button" onclick="closeCancellationModal()">
                    <i class="fas fa-times"></i>
                    Back
                </button>
                <button class="modal-button confirm-button" onclick="confirmCancellation()">
                    <i class="fas fa-check"></i>
                    Confirm Cancellation
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Day navigation functionality
        function getNextDays(count = 10) {
            const days = [];
            const today = new Date();
            
            for (let i = 1; i <= count; i++) { // Start from 1 to skip today
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                days.push(date);
            }
            
            return days;
        }

        function formatDate(date) {
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function initializeDayNavigation() {
            const dayNav = document.getElementById('dayNavigation');
            if (!dayNav) return;

            // Clear existing buttons
            dayNav.innerHTML = '';

            // Create Same Day button with today's date
            const today = new Date();
            const sameDayButton = document.createElement('button');
            sameDayButton.className = 'day-button active';
            sameDayButton.dataset.day = 'same-day';
            sameDayButton.innerHTML = `
                <i class="fas fa-calendar-day"></i>
                Same Day (${formatDate(today)})
            `;
            sameDayButton.onclick = () => switchDay('same-day');
            dayNav.appendChild(sameDayButton);

            // Get next 10 days (excluding today)
            const days = getNextDays(10);
            
            // Create buttons for each day
            days.forEach((date, index) => {
                const button = createDayButton(date, index);
                dayNav.appendChild(button);
            });

            // Load today's time slots by default
            const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
            loadTimeSlots(dayName);
        }

        function createDayButton(date, index) {
            const button = document.createElement('button');
            button.className = 'day-button';
            button.dataset.date = date.toISOString();
            button.innerHTML = `
                <i class="fas fa-calendar"></i>
                ${formatDate(date)}
            `;
            button.onclick = () => switchDay(index);
            return button;
        }

        function switchDay(index) {
            const buttons = document.querySelectorAll('.day-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            const clickedButton = event.target.closest('.day-button');
            if (!clickedButton) return;

            clickedButton.classList.add('active');
            
            // Check if Same Day button was clicked
            if (clickedButton.dataset.day === 'same-day') {
                const today = new Date();
                const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
                loadTimeSlots(dayName, today);
            } else {
                const selectedDate = new Date(clickedButton.dataset.date);
                const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
                loadTimeSlots(dayName, selectedDate);
            }
        }

        // Booking functionality
        let currentBooking = null;

        function openBookingModal(region, product, time) {
            const selectedDayButton = document.querySelector('.day-button.active');
            if (!selectedDayButton) {
                console.error('No day selected');
                return;
            }

            let bookingDate;
            if (selectedDayButton.dataset.day === 'same-day') {
                bookingDate = new Date();
            } else {
                bookingDate = new Date(selectedDayButton.dataset.date);
            }

            currentBooking = { 
                region, 
                product, 
                time,
                date: bookingDate
            };

            document.getElementById('modalRegion').textContent = region;
            document.getElementById('modalProduct').textContent = product;
            document.getElementById('modalTime').textContent = time;
            document.getElementById('modalDate').textContent = bookingDate.toLocaleDateString('en-US', { 
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('bookingModal').classList.add('active');
        }

        window.closeBookingModal = function() {
            document.getElementById('bookingModal').classList.remove('active');
            currentBooking = null;
        }

        window.confirmBooking = async function() {
            if (!currentBooking) return;

            try {
                const user = window.auth.currentUser;
                if (!user) {
                    throw new Error('No user logged in');
                }

                // Get user data
                const userDoc = await window.getDoc(window.doc(window.db, 'users', user.uid));
                const userData = userDoc.data();

                // Get the time slot
                const timeSlotQuery = await window.getDocs(window.query(
                    window.collection(window.db, 'time_slots'),
                    window.where('region', '==', currentBooking.region),
                    window.where('product', '==', currentBooking.product),
                    window.where('time', '==', currentBooking.time)
                ));

                if (timeSlotQuery.empty) {
                    throw new Error('Time slot not found');
                }

                const timeSlotDoc = timeSlotQuery.docs[0];
                const timeSlot = timeSlotDoc.data();

                if (timeSlot.availableSlots <= 0) {
                    throw new Error('No available slots for this time');
                }

                // Create booking with specific date
                const bookingRef = await window.addDoc(window.collection(window.db, 'bookings'), {
                    userId: user.uid,
                    userName: `${userData.firstName} ${userData.lastName}`,
                    region: currentBooking.region,
                    product: currentBooking.product,
                    time: currentBooking.time,
                    date: currentBooking.date.toISOString(),
                    dayOfWeek: currentBooking.date.toLocaleDateString('en-US', { weekday: 'long' }),
                    status: 'confirmed',
                    estimatedDuration: '60-90 minutes',
                    serviceProvider: 'Professional Team',
                    preparationRequired: 'Clear access area',
                    createdAt: window.serverTimestamp()
                });

                // Update time slot availability
                await window.updateDoc(timeSlotDoc.ref, {
                    availableSlots: window.increment(-1),
                    lastModified: window.serverTimestamp()
                });

                // Create user booking reference
                await window.addDoc(window.collection(window.db, 'userBookings'), {
                    userId: user.uid,
                    bookingId: bookingRef.id,
                    region: currentBooking.region,
                    product: currentBooking.product,
                    time: currentBooking.time,
                    date: currentBooking.date.toISOString(),
                    dayOfWeek: currentBooking.date.toLocaleDateString('en-US', { weekday: 'long' }),
                    status: 'confirmed',
                    lastModified: window.serverTimestamp()
                });

                alert('Booking confirmed successfully!');
                window.closeBookingModal();
                loadTimeSlots(); // Refresh the time slots display
            } catch (error) {
                console.error('Error confirming booking:', error);
                alert(error.message || 'Error confirming booking. Please try again.');
            }
        };

        // Add click handlers to time slots
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                const region = this.closest('.region-card').querySelector('.region-title').textContent;
                const product = this.closest('.product-section').querySelector('.product-title').textContent;
                const time = this.querySelector('.time').textContent.trim();
                openBookingModal(region, product, time);
            });
        });

        // Check if user is logged in
        window.auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User is logged in:', user.uid);
                try {
                    // Try to get user from regular_users collection first
                    let userDoc = await window.getDoc(window.doc(window.db, 'regular_users', user.uid));
                    
                    // If not found in regular_users, try users collection
                    if (!userDoc.exists()) {
                        userDoc = await window.getDoc(window.doc(window.db, 'users', user.uid));
                    }

                    if (!userDoc.exists()) {
                        console.error('User document not found in either collection');
                        return;
                    }

                    const userData = userDoc.data();
                    const headerUserInfo = document.querySelector('.header-user-info');
                    if (headerUserInfo) {
                        headerUserInfo.innerHTML = `
                            <div class="user-avatar">
                                ${userData.firstName ? userData.firstName[0] : user.email[0]}
                            </div>
                            <div class="user-details">
                                <div class="user-name">${userData.firstName} ${userData.lastName}</div>
                                <div class="user-role">${userData.role ? userData.role.charAt(0).toUpperCase() + userData.role.slice(1) : 'User'}</div>
                            </div>
                        `;
                    }
                    
                    // Show admin dashboard button for managers and admins
                    if (userData.role === 'manager' || userData.role === 'admin') {
                        document.getElementById('adminDashboardButton').style.display = 'flex';
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    showError('Error loading user data');
                }
            } else {
                console.log('No user is logged in, redirecting to login');
                window.location.href = 'login.html';
            }
        });

        // Initialize regions
        async function initializeRegions() {
            try {
                const regionsGrid = document.querySelector('.regions-grid');
                if (!regionsGrid) {
                    console.error('Regions grid not found');
                    return;
                }

                const snapshot = await window.getDocs(window.collection(window.db, 'regions'));
                
                // Clear existing content
                regionsGrid.innerHTML = '';
                
                for (const doc of snapshot.docs) {
                    const region = doc.data();
                    const regionCard = document.createElement('div');
                    regionCard.className = 'region-card';
                    regionCard.innerHTML = `
                        <div class="region-header">
                            <div class="region-title">${region.name}</div>
                            ${region.subtitle ? `<div class="region-subtitle">${region.subtitle}</div>` : ''}
                        </div>
                        <div class="products-container">
                            <div class="product-section">
                                <div class="product-header">
                                    <div class="product-icon">
                                        <i class="fas fa-bath"></i>
                                    </div>
                                    <div class="product-title">Bathrooms</div>
                                </div>
                                <div class="time-slots-grid" id="${region.name.toLowerCase()}-bathrooms-slots">
                                    <!-- Time slots will be populated here -->
                                </div>
                            </div>
                            <div class="product-section">
                                <div class="product-header">
                                    <div class="product-icon">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="product-title">Roofing</div>
                                </div>
                                <div class="time-slots-grid" id="${region.name.toLowerCase()}-roofing-slots">
                                    <!-- Time slots will be populated here -->
                                </div>
                            </div>
                        </div>
                    `;
                    regionsGrid.appendChild(regionCard);
                }

                // After creating region cards, load time slots
                await loadTimeSlots();
            } catch (error) {
                console.error('Error initializing regions:', error);
                showError('Failed to load regions');
            }
        }

        // Load time slots
        async function loadTimeSlots(dayName, selectedDate) {
            try {
                // Get the selected day if no dayName is provided
                if (!dayName) {
                    const selectedDayButton = document.querySelector('.day-button.active');
                    if (!selectedDayButton) {
                        console.error('No day selected');
                        return;
                    }

                    // Check if it's the Same Day button
                    if (selectedDayButton.dataset.day === 'same-day') {
                        const today = new Date();
                        dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
                        selectedDate = today;
                    } else {
                        // Get the full date from the button's dataset
                        selectedDate = new Date(selectedDayButton.dataset.date);
                        dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
                    }
                }

                console.log('Loading time slots for:', dayName);

                // Query time slots for the selected day
                const timeSlotsQuery = window.query(
                    window.collection(window.db, 'time_slots'),
                    window.where('day', '==', dayName),
                    window.where('isActive', '==', true)
                );

                const timeSlotsSnapshot = await window.getDocs(timeSlotsQuery);
                const timeSlots = timeSlotsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Update the UI with the time slots
                updateTimeSlotsUI(timeSlots, selectedDate);
            } catch (error) {
                console.error('Error loading time slots:', error);
            }
        }

        // Function to recalculate time slot availability
        async function recalculateTimeSlotAvailability() {
            try {
                // Get all active bookings
                const bookingsQuery = window.query(
                    window.collection(window.db, 'bookings'),
                    window.where('status', '==', 'confirmed')
                );
                const bookingsSnapshot = await window.getDocs(bookingsQuery);
                
                // Group bookings by region, product, and time
                const bookingCounts = {};
                bookingsSnapshot.forEach(doc => {
                    const booking = doc.data();
                    const key = `${booking.region}-${booking.product}-${booking.time}`;
                    bookingCounts[key] = (bookingCounts[key] || 0) + 1;
                });

                // Get all time slots
                const timeSlotsQuery = window.query(
                    window.collection(window.db, 'time_slots'),
                    window.where('isActive', '==', true)
                );
                const timeSlotsSnapshot = await window.getDocs(timeSlotsQuery);

                // Update each time slot's availability
                const updatePromises = timeSlotsSnapshot.docs.map(async (doc) => {
                    const timeSlot = doc.data();
                    const key = `${timeSlot.region}-${timeSlot.product}-${timeSlot.time}`;
                    const bookedCount = bookingCounts[key] || 0;
                    const availableSlots = timeSlot.maxSlots - bookedCount;

                    if (timeSlot.availableSlots !== availableSlots) {
                        console.log('Updating time slot availability:', {
                            timeSlotId: doc.id,
                            old: timeSlot.availableSlots,
                            new: availableSlots,
                            maxSlots: timeSlot.maxSlots,
                            bookedCount
                        });

                        return window.updateDoc(doc.ref, {
                            availableSlots: availableSlots,
                            lastModified: window.serverTimestamp()
                        });
                    }
                });

                await Promise.all(updatePromises.filter(Boolean));
                console.log('Time slot availability recalculated');
                
                // Refresh the display
                loadTimeSlots();
            } catch (error) {
                console.error('Error recalculating time slot availability:', error);
            }
        }

        // Setup real-time listeners for time slots and bookings
        function setupTimeSlotListeners() {
            // Listen for time slot changes
            const timeSlotsQuery = window.query(
                window.collection(window.db, 'time_slots'),
                window.where('isActive', '==', true)
            );
            
            window.onSnapshot(timeSlotsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'modified') {
                        const timeSlot = change.doc.data();
                        const containerId = `${timeSlot.region.toLowerCase()}-${timeSlot.product.toLowerCase()}-slots`;
                        const container = document.getElementById(containerId);
                        
                        if (container) {
                            const timeSlotElement = container.querySelector(`[data-time="${timeSlot.time}"]`);
                            if (timeSlotElement) {
                                const availabilityElement = timeSlotElement.querySelector('.slot-count');
                                if (availabilityElement) {
                                    availabilityElement.innerHTML = `
                                        <i class="fas ${timeSlot.availableSlots <= 2 ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                                        ${timeSlot.availableSlots} slots available
                                    `;
                                    availabilityElement.className = `slot-count ${timeSlot.availableSlots <= 2 ? 'low' : ''}`;
                                }
                            }
                        }
                    }
                });
            }, (error) => {
                console.error('Error listening to time slots:', error);
            });

            // Listen for booking changes
            const bookingsQuery = window.query(
                window.collection(window.db, 'bookings')
            );
            
            window.onSnapshot(bookingsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'removed' || change.type === 'modified') {
                        // Recalculate availability when bookings are deleted or modified
                        recalculateTimeSlotAvailability();
                    }
                });
            }, (error) => {
                console.error('Error listening to bookings:', error);
            });
        }

        // Initialize layout controls
        function initializeLayoutControls() {
            // Get the layout controls container
            const layoutControls = document.querySelector('.layout-controls');
            if (!layoutControls) return;

            // Remove size controls if they exist
            const sizeControls = layoutControls.querySelector('.size-controls');
            if (sizeControls) {
                sizeControls.remove();
            }
        }

        // Initialize filters
        function initializeFilters() {
            // Get filter elements
            const bathroomFilter = document.getElementById('filterBathrooms');
            const roofingFilter = document.getElementById('filterRoofing');
            const regionFilter = document.getElementById('regionFilter');

            // Populate region filter
            async function populateRegionFilter() {
                try {
                    const regionsSnapshot = await window.getDocs(window.collection(window.db, 'regions'));
                    regionsSnapshot.forEach(doc => {
                        const region = doc.data();
                        const option = document.createElement('option');
                        option.value = region.name;
                        option.textContent = region.name;
                        regionFilter.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading regions for filter:', error);
                }
            }

            // Apply filters
            function applyFilters() {
                const showBathrooms = bathroomFilter.checked;
                const showRoofing = roofingFilter.checked;
                const selectedRegion = regionFilter.value;

                // Get all region cards
                const regionCards = document.querySelectorAll('.region-card');
                regionCards.forEach(card => {
                    const regionName = card.querySelector('.region-title').textContent;
                    const shouldShowRegion = selectedRegion === 'all' || regionName === selectedRegion;
                    card.style.display = shouldShowRegion ? 'block' : 'none';

                    if (shouldShowRegion) {
                        // Show/hide bathroom sections
                        const productSections = card.querySelectorAll('.product-section');
                        productSections.forEach(section => {
                            const productTitle = section.querySelector('.product-title');
                            if (productTitle) {
                                const isBathroom = productTitle.textContent.includes('Bathrooms');
                                const isRoofing = productTitle.textContent.includes('Roofing');
                                
                                if (isBathroom) {
                                    section.style.display = showBathrooms ? 'flex' : 'none';
                                } else if (isRoofing) {
                                    section.style.display = showRoofing ? 'flex' : 'none';
                                }
                            }
                        });
                    }
                });

                // Update the grid layout
                const regionsGrid = document.querySelector('.regions-grid');
                if (regionsGrid) {
                    // If only one service type is selected, adjust the grid layout
                    if (showBathrooms !== showRoofing) {
                        regionsGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(400px, 1fr))';
                    } else {
                        regionsGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))';
                    }
                }
            }

            // Add event listeners
            bathroomFilter.addEventListener('change', applyFilters);
            roofingFilter.addEventListener('change', applyFilters);
            regionFilter.addEventListener('change', applyFilters);

            // Initialize region filter
            populateRegionFilter();

            // Apply initial filters
            applyFilters();
        }

        // Initialize the page
        async function initializePage() {
            try {
                // Initialize day navigation first
                initializeDayNavigation();
                
                // Then initialize regions and load time slots
                await initializeRegions();
                
                // Setup time slot listeners
                setupTimeSlotListeners();
                
                // Initialize layout controls
                initializeLayoutControls();

                // Initialize filters
                initializeFilters();

                // Listen for time slot updates
                window.addEventListener('timeSlotsUpdated', () => {
                    loadTimeSlots();
                });

                // Recalculate availability on page load
                recalculateTimeSlotAvailability();
            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Failed to initialize page');
            }
        }

        // Show error message
        function showError(message) {
            alert(message);
        }

        // Call initializePage when the document is ready
        document.addEventListener('DOMContentLoaded', initializePage);

        function updateTimeSlotsUI(timeSlots, selectedDate) {
            // Group time slots by region and product
            const slotsByRegionAndProduct = {};
            
            timeSlots.forEach(slot => {
                const key = `${slot.region.toLowerCase()}-${slot.product.toLowerCase()}-slots`;
                if (!slotsByRegionAndProduct[key]) {
                    slotsByRegionAndProduct[key] = [];
                }
                slotsByRegionAndProduct[key].push(slot);
            });

            // Update each region's time slots
            for (const [containerId, slots] of Object.entries(slotsByRegionAndProduct)) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn(`Container not found for ${containerId}`);
                    continue;
                }

                // Sort slots by time
                slots.sort((a, b) => a.time.localeCompare(b.time));

                // Create HTML for slots
                container.innerHTML = slots.map(slot => `
                    <div class="time-slot" data-time="${slot.time}" onclick="window.openBookingModal('${slot.region}', '${slot.product}', '${slot.time}')">
                        <div class="time">
                            <i class="far fa-clock"></i>
                            ${slot.time}
                        </div>
                        <div class="availability">
                            <div class="slot-count ${slot.availableSlots <= 2 ? 'low' : ''}">
                                <i class="fas ${slot.availableSlots <= 2 ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                                ${slot.availableSlots} slots available
                            </div>
                        </div>
                    </div>
                `).join('') || '<div class="no-slots">No available time slots</div>';
            }
        }

        // Function to update user info in header
        async function updateUserInfo() {
            try {
                const user = window.auth.currentUser;
                if (!user) {
                    console.error('No user logged in');
                    return;
                }

                // Try to get user from regular_users collection first
                let userDoc = await window.getDoc(window.doc(window.db, 'regular_users', user.uid));
                
                // If not found in regular_users, try users collection
                if (!userDoc.exists()) {
                    userDoc = await window.getDoc(window.doc(window.db, 'users', user.uid));
                }

                if (!userDoc.exists()) {
                    console.error('User document not found in either collection');
                    return;
                }

                const userData = userDoc.data();
                const headerUserInfo = document.querySelector('.header-user-info');
                if (headerUserInfo) {
                    headerUserInfo.innerHTML = `
                        <div class="user-avatar">
                            ${userData.firstName ? userData.firstName[0] : user.email[0]}
                        </div>
                        <div class="user-details">
                            <div class="user-name">${userData.firstName} ${userData.lastName}</div>
                            <div class="user-role">${userData.role ? userData.role.charAt(0).toUpperCase() + userData.role.slice(1) : 'User'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error updating user info:', error);
            }
        }

        // Call updateUserInfo when auth state changes
        window.onAuthStateChanged(window.auth, (user) => {
            if (user) {
                updateUserInfo();
            }
        });
    </script>
</body>
</html> 